---
title: "Untitled"
author: "Marina Alexander"
date: "02/09/2020"
output:
  pdf_document: default
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}

# remind R where to look for libraries
.libPaths(c("C:/Users/ale097/Data School/Packages"))
# load libraries
library(tidyverse)
library(dplyr)
library(knitr)
library(dplyr)
library(readr)
library(vroom)
library(stringr)
library(EnhancedVolcano)
library(viridis)
library(ggsci)
library(cowplot)
library(patchwork)
library(ggsignif)
library(DESeq2)


knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center'
)
```

```{r }

rm(list=ls())

SARSCO2_Calu3_counts <- read.csv("data/SARSCOV2_Calu3_all_samples.csv")
SARSCO2_Calu3_metadata <- read.csv("data/metadata_mRNA_SARSCOV2_Calu3.csv")

df <- read.csv("data/SARSCOV2_Calu3_all_samples.csv", header=TRUE, row.names=1)

dim(df)

md <- read.csv("data/metadata_mRNA_SARSCOV2_Calu3.csv", header=TRUE, row.names=1)

dim(md)

#merge count and metadata file
all(rownames(md) == colnames (df))

# Calculate counts per million.
# Filter rows: at least 3 samples must have at least 1 cpm.
# Retain rows according to 'keep' and nothing on columns.
cpm <- apply(df, 2, function(x) (x/sum(x))*1000000)
keep <- rowSums( cpm >= 1 ) >=4
df_filtered <- df[ keep, ]

dim(df_filtered)


# Construct a SummarizedExperiment object:
dds <- DESeqDataSetFromMatrix(
  countData = df_filtered,
  colData = md,
  design = ~ condition) # ~ is representative of 'by', i.e. compare by condition


# Perform DE testing:
dds <- DESeq(dds)

# Output normalized counts:
norm_counts <- counts (dds, normalized=TRUE)
write.csv(norm_counts, file="results/DESeq2_SARSCOV2_Calu3_all_normalized_counts.csv")


# Convert results to dataframe:
CoV2genes24hr <- results(dds, contrast = c("condition", "SARSCOV2_24hr", "uninfected_24hr"))




```

```{r listing the significant DE genes }
# Set adjusted p-value significance (padj) threshold:
alpha <- c( 0.05 )
# Set log2FoldChange threshold:
# As it's log2, > 1 is actually equal to 2-fold change or above.
beta <- c( 1 )
# Set baseMean threshold:
gamma <- c( 5 )

# 'Which' provides positions of 'TRUE' values.
sigCoV2genes24hr<- CoV2genes24hr[ which( CoV2genes24hr$padj < alpha), ]
# Slices out rows where the adjusted p-value is <0.05.
sigCoV2genes24hr <- sigCoV2genes24hr[ which( abs(sigCoV2genes24hr$log2FoldChange) > beta), ]
# Slices out rows where the fold change is above 2 and below -2.
# Abs=absolute, tells it to filter things above 2, ignoring whether value is positive or negative.
sigCoV2genes24hr <- sigCoV2genes24hr[ which(sigCoV2genes24hr$baseMean > gamma), ]
write.csv(sigCoV2genes24hr, file="results/sigCoV2genes24hr.csv")
# Slices out rows above an average count of 10 reads (anything below is rubbish).

CoV2genes24hr_hits <- rownames(sigCoV2genes24hr)
length(CoV2genes24hr_hits)
write.csv(norm_counts[CoV2genes24hr_hits, ], file="results/DESeq2_sig_CoV2genes24hr_normalized_counts.csv")

SARSCOV2_DEgenes_Calu3_24hrs <- read_csv("results/sigCoV2genes24hr.csv") %>%
  as.data.frame() %>% 
  separate(X1, c("gene", "gene1"), sep = "_") %>% 
  select(-gene1) %>%
  arrange(padj)

write.csv(SARSCOV2_DEgenes_Calu3_24hrs, "results/SARSCOV2_DEgenes_Calu3_24hrs.csv")

SARSCOV2_DEgenes_Calu3_24hrs_david <- SARSCOV2_DEgenes_Calu3_24hrs %>% 
  select(gene)

write.csv(SARSCOV2_DEgenes_Calu3_24hrs_david, "results/SARSCOV2_DEgenes_Calu3_24hrs_david.csv")

```


```{r PCA  }

#join with the counts data 

all_expression <- read_csv("results/DESeq2_SARSCOV2_Calu3_all_normalized_counts.csv") %>%
  gather(name, norm_counts, -X1) %>%
  left_join(SARSCO2_Calu3_metadata, by = "name")


#scale gene expression for all samples 
scaled_genes <- all_expression %>%
  spread(X1, norm_counts) %>%
  select( -cells, -infection, -rep, -condition, -timepoint) %>% 
  column_to_rownames("name") %>% 
  scale()


#use the prcomp function on scaled samples
pca_genes <- prcomp(scaled_genes)

#tidy data frame for plotting
PCA_data <- pca_genes$x %>% 
  as_tibble(rownames = "name") %>%
  gather(PC, variance, -name) %>% 
  left_join(SARSCO2_Calu3_metadata, by = "name") %>%
  spread(PC, variance) %>% 
  separate(name, c("extraction", "sample", "mapping_index"))

#plot to examine variance for all samples 
pca_plot_sample <- ggplot(PCA_data, aes(x = PC1, y = PC2)) +
  geom_text(aes(label = sample), size = 4)
  
ggsave(filename = "results/pca_plot_samples.png", plot = pca_plot_sample, width = 12, height = 10, dpi = 300, units = "cm")
```


```{r Volcano plots  }


forplotting_ILRUNgenesUninf6hr <- ILRUNgenesUninf6hr %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  separate(rowname, c("gene", "gene1"), sep = "_") %>% 
  select(-gene1) %>% 
  mutate(gene = str_replace(gene, "C6orf106", "ILRUN")) %>% 
  mutate(gene = str_replace(gene, "ACKR3", "CXCR7")) %>%
  mutate(gene = str_replace(gene, "CHUK","IkBKA")) %>%
  mutate(gene = str_replace(gene, "TNFSF10", "TRAIL")) %>% 
  remove_rownames %>% 
  column_to_rownames(var="gene")

write.csv(forplotting_ILRUNgenesUninf6hr, "results/ILRUNgenesUninf6hr_forplotting.csv")

##show only significant immune genes ###

APC <- read.csv(("data/KEGG_Immune.system_Antigen.processing.and.presentation_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

B_cell <- read.csv(("data/KEGG_Immune.system_B.cell.receptor.signalling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Chemokine <- read.csv(("data/KEGG_Immune.system_Chemokine.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Complement <- read.csv(("data/KEGG_Immune.system_Complement.and.coagulation.cascades_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Lectin <- read.csv(("data/KEGG_Immune.system_C-type.lectin.receptor.signalling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

DNAsensing <- read.csv(("data/KEGG_Immune.system_Cytosolic.DNA-sensing.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Fcepsilon <- read.csv(("data/KEGG_Immune.system_Fc.epsilon.RI.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Fcgamma <- read.csv(("data/KEGG_Immune.system_Fc.gamma.R-mediated.phagocytosis_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Hematopoetic <- read.csv(("data/KEGG_Immune.system_Hematopoietic.cell.lineage_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

IL17 <- read.csv(("data/KEGG_Immune.system_IL-17.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

IntestinalIgA <- read.csv(("data/KEGG_Immune.system_Intestinal.immune.network.for.IgA.production_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

LeukocyeMigration <- read.csv(("data/KEGG_Immune.system_Leukocyte.transendothelial.migration_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

NKT <- read.csv(("data/KEGG_Immune.system_Natural.killer.cell.mediated.cytotoxicity_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

NOD <- read.csv(("data/KEGG_Immune.system_NOD-like.receptor.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Platelet <- read.csv(("data/KEGG_Immune.system_Platelet.activation_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

RIGI <- read.csv(("data/KEGG_Immune.system_RIG-I-like.receptor.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Tcell <- read.csv(("data/KEGG_Immune.system_T.cell.receptor.signalling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Th1Th2 <- read.csv(("data/KEGG_Immune.system_Th1.and.Th2.cell.differentiation_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene) %>% 
  filter(gene != "	 M ")

Th17 <- read.csv(("data/KEGG_Immune.system_Th17.cell.differentiation_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

Toll <- read.csv(("data/KEGG_Immune.system_Toll-like.receptor.signaling.pathway_genes.csv"),  row.names=NULL, header = FALSE) %>%
  as_tibble() %>% 
  separate(V1, c("desription", "gene"), sep = "RefSeq") %>% 
  mutate(gene_id = str_remove_all(gene, "[\\),]")) %>% 
  select(gene_id) %>% 
  filter(gene_id != "NA") %>% 
  separate(gene_id, c("gene", "extra"), sep = ";") %>%
  select(gene)

KEGG_immune_system_joined <- full_join(APC, B_cell, by = "gene") %>% 
  full_join(Chemokine,by = "gene") %>% 
  full_join(Complement,by = "gene") %>% 
  full_join(DNAsensing,by = "gene") %>% 
  full_join(Fcepsilon,by = "gene") %>% 
  full_join(Fcgamma,by = "gene") %>% 
  full_join(Hematopoetic,by = "gene") %>%
  full_join(IL17,by = "gene") %>% 
  full_join(IntestinalIgA,by = "gene") %>% 
  full_join(Lectin,by = "gene") %>% 
  full_join(LeukocyeMigration, by = "gene") %>% 
  full_join(NKT,by = "gene") %>% 
  full_join(NOD,by = "gene") %>% 
  full_join(Platelet,by = "gene") %>% 
  full_join(RIGI,by = "gene") %>% 
  full_join(Th17,by = "gene") %>% 
  full_join(Tcell,by = "gene") %>% 
  full_join(Th1Th2,by = "gene") %>% 
  full_join(Toll,by = "gene")

#### Trim all the white space ###########
KEGG_immune_system <- stri_trim(KEGG_immune_system_joined$gene) %>% 
  as_tibble() %>%
  rename(gene = value) %>% 
  filter(gene != "M")

tibble_ILRUNgenesUninf6hr <- ILRUNgenesUninf6hr %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  separate(rowname, c("gene", "gene1"), sep = "_") %>% 
  select(-gene1)

#526 genes of the immune system detected
#344 genes significantly different between siNEG and siILRUN 
#57 genes with log2FC more than 0.75

immune_genes_Uninf6hr <- KEGG_immune_system %>%
  left_join(tibble_ILRUNgenesUninf6hr , by = "gene") %>%
  filter(baseMean != "NA") %>% 
  filter(padj <0.05 ) %>% 
  filter(log2FoldChange >0.75 | log2FoldChange < -0.75) 
  
mutate(gene = str_replace(gene, "C6orf106", "ILRUN")) %>% 
  mutate(gene = str_replace(gene, "ACKR3", "CXCR7")) %>%
  mutate(gene = str_replace(gene, "CHUK","IkBKA")) %>%
  mutate(gene = str_replace(gene, "TNFSF10", "TRAIL"))



#########################################

volcano_plot_ILRUNgenesUninf6hr <- EnhancedVolcano(forplotting_ILRUNgenesUninf6hr,
                                                 lab = rownames(forplotting_ILRUNgenesUninf6hr),
                                                 x = 'log2FoldChange',
                                                 y = 'padj',
                                                 selectLab = c(immune_genes_Uninf6hr$gene),
                                                 xlim = c(-3, 3),
                                                 title = 'ILRUN genes 6hr',
                                                 pCutoff = 0.05,
                                                 FCcutoff = 0.5,
                                                 pointSize = 4.0,
                                                 labSize = 5.0,
                                                 labCol = 'black',
                                                 labFace = 'bold',
                                                 boxedLabels = TRUE,
                                                 colAlpha = 4/5,
                                                 legendPosition = 'right',
                                                 legendLabSize = 14,
                                                 legendIconSize = 4.0,
                                                 drawConnectors = TRUE,
                                                 widthConnectors = 1.0,
                                                 colConnectors = 'black')


ggsave(filename = "results/volcano_plot_ILRUNgenesUninf6hr.png", plot = volcano_plot_ILRUNgenesUninf6hr, width = 30, height = 25, dpi = 300, units = "cm")


```

