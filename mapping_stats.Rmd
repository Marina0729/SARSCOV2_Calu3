---
title: "CDS_mapped_reads"
author: "Marina Alexander"
date: "08/10/2020"
output:
  pdf_document: default
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}

# remind R where to look for libraries
.libPaths(c("C:/Users/ale097/Data School/Packages"))
# load libraries
library(tidyverse)
library(dplyr)
library(knitr)
library(readr)
library(vroom)
library(stringr)
library(EnhancedVolcano)
library(viridis)
library(ggsci)
library(cowplot)
library(patchwork)
library(ggsignif)
library(DESeq2)
library(biomaRt)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center'
)
```

```{r}

CDS_mapped <- read.csv("data/read_lengths_CDS.csv") %>%
  gather(sample, counts, -read_length)

plot01 <- CDS_mapped %>% 
  filter(sample == "sample_01") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample01")
plot02 <- CDS_mapped %>% 
  filter(sample == "sample_02") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample02")
plot03 <- CDS_mapped %>% 
  filter(sample == "sample_03") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample03")
plot04 <- CDS_mapped %>% 
  filter(sample == "sample_04") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample04")
plot05 <- CDS_mapped %>% 
  filter(sample == "sample_05") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample05")
plot06 <- CDS_mapped %>% 
  filter(sample == "sample_06") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample06")
plot07 <- CDS_mapped %>% 
  filter(sample == "sample_07") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample07")
plot08 <- CDS_mapped %>% 
  filter(sample == "sample_08") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample08")
plot09 <- CDS_mapped %>% 
  filter(sample == "sample_09") %>% 
  ggplot(aes(x = read_length, y = counts)) +
  geom_bar(stat="identity")+
  labs(title = "sample09")

plot_all <- plot_grid(plot01, plot02, plot03, plot04, plot05, plot06, plot07, plot08, plot09)

ggsave(filename = "results/allsamples_CDSreadlengths.png", plot = plot_all, width = 15, height = 10, dpi = 300, units = "cm")

```

```{r}

CDS_mapped_freq <- read.csv("data/read_lengths_CDS_frequency.csv") %>%
  gather(sample, frequency, -read_length)

write.csv(CDS_mapped_freq, "results/gathered_CDS_mapped_freq.csv")

CDS_mapped_freq_timepoint <- read.csv("results/gathered_CDS_mapped_freq_timepoint.csv")

CDS_mapped_freq_timepoint$timepoint <- factor(CDS_mapped_freq_timepoint$timepoint, levels=c("0hr", "6hr", "24hr"))

freq_readlength_plot <- ggplot(CDS_mapped_freq_timepoint, aes(x = read_length, y = frequency, color = sample))+
  geom_line()+
  geom_vline(xintercept = 28, color = "red", linetype = "dashed")+
  facet_wrap(~timepoint, nrow = 3)+
  ylim(0, 18)+
  xlim(15, 41)+
  labs(y = "frequency (%)",
       x = "read length", 
       title = "Read length distribution for footprints mapping to CDS" )

ggsave(filename = "results/freq_readlength_plot.png", plot = freq_readlength_plot, width = 20, height = 20, dpi = 300, units = "cm")

```

```{r}
library(readr)

sample1_total_reads <- read.csv("data/sample1_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s1")
sample1_RPKM_stats <- read.csv("data/sample1_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host, Chr) %>%
  mutate(sample = "s1") %>%
  mutate(timepoint = "0hr") %>%
  mutate(RPM = (CDS/sample1_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>% 
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

sample2_total_reads <- read.csv("data/sample2_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s2")
sample2_RPKM_stats <- read.csv("data/sample2_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s2") %>%
  mutate(timepoint = "0hr") %>%
  mutate(RPM = (CDS/sample2_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>% 
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

sample3_total_reads <- read.csv("data/sample3_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s3")
sample3_RPKM_stats <- read.csv("data/sample3_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s3") %>%
  mutate(timepoint = "0hr") %>%
  mutate(RPM = (CDS/sample3_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>% 
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

sample4_total_reads <- read.csv("data/sample4_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s4")
sample4_RPKM_stats <- read.csv("data/sample4_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s4") %>%
  mutate(timepoint = "6hr") %>%
  mutate(RPM = (CDS/sample4_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>% 
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

sample5_total_reads <- read.csv("data/sample5_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s5")
sample5_RPKM_stats <- read.csv("data/sample5_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s5") %>%
  mutate(timepoint = "6hr") %>%
  mutate(RPM = (CDS/sample5_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>%
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

sample6_total_reads <- read.csv("data/sample6_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s6")
sample6_RPKM_stats <- read.csv("data/sample6_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s6") %>%
  mutate(timepoint = "6hr") %>%
  mutate(RPM = (CDS/sample6_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>%
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 


sample7_total_reads <- read.csv("data/sample7_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s7")
sample7_RPKM_stats <- read.csv("data/sample7_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s7") %>%
  mutate(timepoint = "24hr") %>%
  mutate(RPM = (CDS/sample7_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>%
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 


sample8_total_reads <- read.csv("data/sample8_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s8")
sample8_RPKM_stats <- read.csv("data/sample8_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s8") %>%
  mutate(timepoint = "24hr") %>%
  mutate(RPM = (CDS/sample8_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>%
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM))

sample9_total_reads <- read.csv("data/sample9_CDS.csv", skip =1) %>% 
  summarise(total_reads = sum(CDS)) %>% 
  mutate(sample= "s9")
sample9_RPKM_stats <- read.csv("data/sample9_CDS.csv", skip = 1) %>%
  mutate(host = case_when(str_detect(Geneid, "ENSG") ~ TRUE, TRUE ~ FALSE )) %>%
  dplyr::select(Geneid, Length, CDS, host) %>%
  mutate(sample = "s9") %>%
  mutate(timepoint = "24hr") %>%
  mutate(RPM = (CDS/sample9_total_reads$total_reads)*1000000) %>% 
  mutate(RPKM = (RPM/Length)*1000) %>%
  filter(RPKM >100 ) %>%
  group_by(host, sample, timepoint) %>% 
  summarise(RPKM_mean_per_gene = mean(RPKM)) 

all_samples_libsize <- bind_rows(sample1_total_reads, sample2_total_reads, sample3_total_reads, sample4_total_reads, sample5_total_reads, sample6_total_reads, sample7_total_reads, sample8_total_reads, sample9_total_reads)

all_samples <- bind_rows(sample2_RPKM_stats, sample3_RPKM_stats, sample4_RPKM_stats, sample5_RPKM_stats, sample6_RPKM_stats, sample7_RPKM_stats, sample8_RPKM_stats, sample9_RPKM_stats) %>% 
  mutate(genome = str_replace_all(host, c("FALSE" = "SARSCOV2", "TRUE" = "human")))
  
all_samples$timepoint <- factor(all_samples$timepoint, levels = c("0hr", "6hr", "24hr"))  

plot_RPKM <- ggplot(all_samples, aes(y= RPKM_mean_per_gene, x= timepoint, color = genome))+
  geom_boxplot()+
  scale_y_log10()


```
```{r  using mitochondially encoded genes to act as normalisation control }

#Building a counts table for DESeq2
Geneid <- read.csv("data/sample1_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>% 
  dplyr::select(Geneid, length)

sample1_select <- read.csv("data/sample1_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s1 = CDS) %>% 
  dplyr::select(s1)
sample2_select <- read.csv("data/sample2_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM")%>%
  dplyr::rename(s2 = CDS) %>% 
  dplyr::select(s2)
sample3_select <- read.csv("data/sample3_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM")%>%
  dplyr::rename(s3 = CDS) %>% 
  dplyr::select(s3)
sample4_select <- read.csv("data/sample4_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s4 = CDS) %>% 
  dplyr::select(s4)
sample5_select <- read.csv("data/sample5_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s5 = CDS) %>% 
  dplyr::select(s5)
sample6_select <- read.csv("data/sample6_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s6 = CDS) %>% 
  dplyr::select(s6)
sample7_select <- read.csv("data/sample7_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s7 = CDS) %>% 
  dplyr::select(s7)
sample8_select <- read.csv("data/sample8_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM")%>%
  dplyr::rename(s8 = CDS) %>% 
  dplyr::select(s8)
sample9_select <- read.csv("data/sample9_CDS.csv", skip =1) %>% 
  filter(Chr == "chrM") %>%
  dplyr::rename(s9 = CDS) %>% 
  dplyr::select(s9)

all_samples_chrM <- bind_cols(Geneid,sample1_select,sample2_select,sample3_select,sample4_select,sample5_select,sample6_select,
                              sample7_select,sample8_select,sample9_select)
write.csv(all_samples_chrM, "data/chrM_CDS_counts")

```
